#!/usr/bin/env node
"use strict";

/* -------------------------------------------------- 1 ▪ Node version */
try {structuredClone({});}
catch {
	console.error(`We require Node 18+; you’re using ${process.version}`);
	process.exit(1);
}

/* -------------------------------------------------- 2 ▪ CLI flags */
const decl = ['--decl', 'decl'].includes(process.argv[2]);        // emit .d.ts
const force = decl || ['--force', 'force', '--full', 'full'].includes(process.argv[2]);

/* -------------------------------------------------- 3 ▪ Bootstrap */
const {execSync} = require('child_process');
const fs = require('fs');
process.chdir(__dirname);

function shell(cmd) {execSync(cmd, {stdio: 'inherit'});}

/* ensure build-time deps are installed on a fresh checkout */
for (const pkg of ['oxc-transform', 'fast-glob', 'typescript']) {
	try {require.resolve(pkg);}
	catch {shell(`npm install ${pkg}`);}
}

/* ensure ./config/config.js exists */
try {require.resolve('./config/config');}
catch (err) {
	if (err.code !== 'MODULE_NOT_FOUND') throw err;
	fs.mkdirSync('config', {recursive: true});
	fs.copyFileSync('config/config-example.js', 'config/config.js');
}

/* -------------------------------------------------- 4 ▪ Build */
setImmediate(() => {
	require('./tools/build-utils').transpile(force, decl);
});
